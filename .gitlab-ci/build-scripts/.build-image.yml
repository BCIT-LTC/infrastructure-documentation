# Build image with Kaniko and push to project registry
.build_image:
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  variables:
    IMAGE_LABELS: >
      --label org.opencontainers.image.source=$CI_PROJECT_URL --label git_tag=$GIT_TAG --label org.opencontainers.image.version=$IMAGE_TAG

    KANIKO_CACHE_ARGS: "--cache=true --cache-copy-layers=true --cache-ttl=24h"
    KANIKO_SNAPSHOT_ARGS: "--snapshotMode=redo"
  script:
    - "echo -e \"Building and shipping image to $CI_REGISTRY_IMAGE\"\n\nIMAGE_TITLE=$(echo $CI_PROJECT_TITLE | tr \" \" \"_\")\n\n# \\$BUILD_DATE will be slightly different from \\$CI_PIPELINE_CREATED_AT\nBUILD_DATE=\"$(date '+%FT%T%z' | sed -E -n 's/(\\+[0-9]{2})([0-9]{2})$/\\1:\\2/p')\"   #rfc 3339 date\n\n# Inject build envs into image\necho -e \"\\nGIT_TAG=$GIT_TAG\\\n\\nIMAGE_TAG=$IMAGE_TAG\\\n\\nIMAGE_TITLE=$IMAGE_TITLE\\\n\\nBUILD_DATE=$BUILD_DATE\\\n\\n\" \\\n> .env\n\nIMAGE_LABELS=\"$IMAGE_LABELS \\\n  --label org.opencontainers.image.title=$IMAGE_TITLE \\\n  --label org.opencontainers.image.created=$BUILD_DATE\"\n\necho -e \" \\\n  \\nImage Labels being applied: \\\n  \\n  org.opencontainers.image.source=$CI_PROJECT_URL \\\n  \\n  git_tag=$GIT_TAG \\\n  \\n  org.opencontainers.image.version=$IMAGE_TAG \\\n  \\n  org.opencontainers.image.title=$IMAGE_TITLE \\\n  \\n  org.opencontainers.image.created=$BUILD_DATE \\\n  \\n\"\n  \nADDITIONALTAGLIST=\"$ADDITIONALTAGLIST $IMAGE_TAG\"\n\nif [[ \"$CI_COMMIT_BRANCH\" == \"$CI_DEFAULT_BRANCH\" ]]; then ADDITIONALTAGLIST=\"$ADDITIONALTAGLIST $GIT_TAG latest\"; fi\n\nif [[ -n \"$ADDITIONALTAGLIST\" ]]; then \n  for TAG in $ADDITIONALTAGLIST; do \n    FORMATTEDTAGLIST=\"${FORMATTEDTAGLIST} --tag $CI_REGISTRY_IMAGE:$TAG \"; \n  done;\nfi\n\n# Reformat Docker tags to kaniko's --destination argument:\nFORMATTEDTAGLIST=$(echo \"${FORMATTEDTAGLIST}\" | sed s/\\-\\-tag/\\-\\-destination/g) \n\nmkdir -p /kaniko/.docker\n\necho \"{\\\"auths\\\":{\\\"$CI_REGISTRY\\\":{\\\"auth\\\":\\\"$(echo -n $CI_REGISTRY_USER:$CI_REGISTRY_PASSWORD | base64)\\\"}}}\" \\\n  > /kaniko/.docker/config.json\n/kaniko/executor \\\n  --context $CI_PROJECT_DIR \\\n  --dockerfile $CI_PROJECT_DIR/Dockerfile $KANIKO_CACHE_ARGS $KANIKO_SNAPSHOT_ARGS $FORMATTEDTAGLIST $IMAGE_LABELS"
